# Docker Compose version
version: '3.8'

# Define all services (containers) that make up the application
services:
  
  # PostgreSQL Database Service
  postgres:
    # Use official PostgreSQL 15 image from Docker Hub
    image: postgres:15
    
    # Container name (easier to identify)
    container_name: ai-control-plane-db
    
    # Environment variables for PostgreSQL
    environment:
      # Database credentials (from .env)
      POSTGRES_USER: Ayush # your username
      POSTGRES_PASSWORD: Ayush123 # your password
      POSTGRES_DB: ai_control_plane # your database name
    
    # Port mapping: host:container
    # Access PostgreSQL at localhost:5432 from your computer
    ports:
      - "5432:5432"
    
    # Volume for persistent data
    # Data survives even if container is deleted
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    # Health check to ensure database is ready
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U Ayush"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # Restart policy
    restart: unless-stopped

  # Control Plane Service (FastAPI)
  control-plane:
    # Build from Dockerfile in ./control-plane directory
    build:
      context: ./control-plane
      dockerfile: Dockerfile
    
    # Container name
    container_name: ai-control-plane-api
    
    # Port mapping: host:container#
    # Access API at http://localhost:8000
    ports:
      - "8000:8000"
    
    # Environment variables
    environment:
      # Database connection string
      # Note: Use 'postgres' as hostname (service name in docker-compose)
      DATABASE_URL: postgresql://Ayush:Ayush123@postgres:5432/ai_control_plane
      
      # Redis connection (use service name 'redis' as hostname)
      REDIS_URL: redis://default:Ayush@123@redis:6379
      
      # JWT Configuration
      SECRET_KEY: ${SECRET_KEY:-09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      
      # SMTP Configuration for emails
      SMTP_MAIL: ${SMTP_MAIL:-your_email_here}
      SMTP_PASS: ${SMTP_PASS:-your_app_password_here}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      
      # Gemini API key for AI features
      GEMINI_API_KEY: ${GEMINI_API_KEY:-your_gemini_api_key_here}
    #
    # Volume mounting for development
    # Maps local ./control-plane to /app in container
    # Changes to code on your computer reflect immediately in container!
    volumes:
      - ./control-plane:/app
      # Exclude these directories (keep them in container)
      - /app/__pycache__
      - /app/venv
    
    # Wait for postgres and redis to be healthy before starting
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # Restart policy
    restart: unless-stopped

  # Demo Service (Express/Node.js)
  demo-service:
    # Build from Dockerfile in ./demo-service directory
    build:
      context: ./demo-service
      dockerfile: Dockerfile
    
    # Container name
    container_name: ai-control-plane-demo
    
    # Port mapping: host:container
    # Access demo service at http://localhost:3001
    ports:
      - "3001:3001"
    
    # Environment variables
    environment:
      # Control plane URL
      # Note: Use 'control-plane' as hostname (service name in docker-compose)
      CONTROL_PLANE_URL: http://control-plane:8000
    
    # Volume mounting for development
    # Maps local ./demo-service to /app in container
    volumes:
      - ./demo-service:/app
      # Exclude node_modules (keep them in container)
      - /app/node_modules
    
    # Wait for control-plane to start
    depends_on:
      - control-plane
    
    # Restart policy
    restart: unless-stopped

  # pgAdmin Service (Database Management UI)
  pgadmin:
    # Use official pgAdmin 4 image
    image: dpage/pgadmin4:latest
    
    # Container name
    container_name: ai-control-plane-pgadmin
    
    # Environment variables for pgAdmin
    environment:
      # Login credentials for pgAdmin web interface
      PGADMIN_DEFAULT_EMAIL: sudhirsoni9889@gmail.com # your email
      PGADMIN_DEFAULT_PASSWORD: admin123 # your password
      # Disable master password prompt
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    
    # Port mapping: host:container
    # Access pgAdmin at http://localhost:5050
    ports:
      - "5051:80"
    
    # Volume for persistent pgAdmin data
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    
    # Wait for postgres to start
    depends_on:
      - postgres
    
    # Restart policy
    restart: unless-stopped

  # Redis Service (Caching & Real-time Data)
  redis:
    # Use official Redis 7 Alpine image (lightweight)
    image: redis:7-alpine
    
    # Container name
    container_name: ai-control-plane-redis
    
    # Port mapping: host:container
    # Access Redis at localhost:6379
    ports:
      - "6379:6379"
    
    # Command to run Redis with persistence and password (matches .env)
    command: redis-server --appendonly yes --requirepass "Ayush@123"
    
    # Volume for persistent Redis data
    volumes:
      - redis_data:/data
    
    # Health check to ensure Redis is ready
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    
    # Restart policy
    restart: unless-stopped

  # Redis Insight Service (Redis Management UI)
  redis-insight:
    # Use official RedisInsight image
    image: redis/redisinsight:latest
    
    # Container name
    container_name: ai-control-plane-redis-insight
    
    # Port mapping: host:container
    # Access Redis Insight at http://localhost:5540
    ports:
      - "5540:5540"
    
    # Volume for persistent Redis Insight data
    volumes:
      - redis_insight_data:/data
    
    # Wait for Redis to start
    depends_on:
      redis:
        condition: service_healthy
    
    # Restart policy
    restart: unless-stopped

# Named volumes
# These persist data even when containers are deleted
volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  redis_data:
    driver: local
  redis_insight_data:
    driver: local
